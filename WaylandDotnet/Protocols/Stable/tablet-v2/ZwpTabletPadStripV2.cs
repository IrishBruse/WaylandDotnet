// <auto-generated>
// This file was generated from tablet-v2.xml
// Stability: Stable
// Link: https://wayland.app/protocols/tablet-v2
// </auto-generated>

#nullable enable
#pragma warning disable CS1591
#pragma warning disable CS0108
#pragma warning disable CS8604

namespace WaylandDotnet.Stable;

using System;
using System.Runtime.CompilerServices;
using System.Runtime.InteropServices;
using System.Runtime.InteropServices.Marshalling;
using System.Text;
using WaylandDotnet;
using WaylandDotnet.Internal;
using WaylandDotnet.Stable;
using WaylandDotnet.Wlr;

/// <summary>
/// zwp_tablet_pad_strip_v2
/// <para> pad strip </para>
/// <para> Version: 2 </para>
/// <see>https://wayland.app/protocols/tablet-v2/#zwp_tablet_pad_strip_v2</see>
/// </summary>
public sealed partial class ZwpTabletPadStripV2 : WaylandObject, IWaylandObjectFactory<ZwpTabletPadStripV2>
{
    public const string InterfaceName = "zwp_tablet_pad_strip_v2";
    public static string _StaticInterfaceName => "zwp_tablet_pad_strip_v2";
    public const int InterfaceVersion = 2;

    private GCHandle gcHandle;
    private bool dispatcherRegistered = false;
    private readonly object dispatcherLock = new object();

    public ZwpTabletPadStripV2(IntPtr handle, WlDisplay display) : base(handle, display, InterfaceName, InterfaceVersion)
    {
    }
    /// <summary> strip axis source </summary>
    public enum Source : uint
    {
        /// <summary>
        /// finger
        /// </summary>
        Finger = 1,
    }

    public delegate void SourceHandler(uint source);

    private SourceHandler? _onSource;

    /// <summary>
    ///Strip event source
    /// <para>
    ///
    ///Source information for strip events.
    ///
    ///This event does not occur on its own. It is sent before a
    ///zwp_tablet_pad_strip_v2.frame event and carries the source information
    ///for all events within that frame.
    ///
    ///The source specifies how this event was generated. If the source is
    ///zwp_tablet_pad_strip_v2.source.finger, a zwp_tablet_pad_strip_v2.stop event
    ///will be sent when the user lifts their finger off the device.
    ///
    ///This event is optional. If the source is unknown for an interaction,
    ///no event is sent.
    ///
    /// </para>
    /// </summary>
    public event SourceHandler? OnSource
    {
        add
        {
            CheckDisposed();
            _onSource += value;
            EnsureDispatcherRegistered();
        }

        remove
        {
            _onSource -= value;
        }
    }

    public delegate void PositionHandler(uint position);

    private PositionHandler? _onPosition;

    /// <summary>
    ///Position changed
    /// <para>
    ///
    ///Sent whenever the position on a strip changes.
    ///
    ///The position is normalized to a range of [0, 65535], the 0-value
    ///represents the top-most and/or left-most position of the strip in
    ///the pad's current rotation.
    ///
    /// </para>
    /// </summary>
    public event PositionHandler? OnPosition
    {
        add
        {
            CheckDisposed();
            _onPosition += value;
            EnsureDispatcherRegistered();
        }

        remove
        {
            _onPosition -= value;
        }
    }

    public delegate void StopHandler();

    private StopHandler? _onStop;

    /// <summary>
    ///Interaction stopped
    /// <para>
    ///
    ///Stop notification for strip events.
    ///
    ///For some zwp_tablet_pad_strip_v2.source types, a zwp_tablet_pad_strip_v2.stop
    ///event is sent to notify a client that the interaction with the strip
    ///has terminated. This enables the client to implement kinetic
    ///scrolling. See the zwp_tablet_pad_strip_v2.source documentation for
    ///information on when this event may be generated.
    ///
    ///Any zwp_tablet_pad_strip_v2.position events with the same source after this
    ///event should be considered as the start of a new interaction.
    ///
    /// </para>
    /// </summary>
    public event StopHandler? OnStop
    {
        add
        {
            CheckDisposed();
            _onStop += value;
            EnsureDispatcherRegistered();
        }

        remove
        {
            _onStop -= value;
        }
    }

    public delegate void FrameHandler(uint time);

    private FrameHandler? _onFrame;

    /// <summary>
    ///End of a strip event sequence
    /// <para>
    ///
    ///Indicates the end of a set of events that represent one logical
    ///hardware strip event. A client is expected to accumulate the data
    ///in all events within the frame before proceeding.
    ///
    ///All zwp_tablet_pad_strip_v2 events before a zwp_tablet_pad_strip_v2.frame event belong
    ///logically together. For example, on termination of a finger interaction
    ///on a strip the compositor will send a zwp_tablet_pad_strip_v2.source event,
    ///a zwp_tablet_pad_strip_v2.stop event and a zwp_tablet_pad_strip_v2.frame
    ///event.
    ///
    ///A zwp_tablet_pad_strip_v2.frame event is sent for every logical event
    ///group, even if the group only contains a single zwp_tablet_pad_strip_v2
    ///event. Specifically, a client may get a sequence: position, frame,
    ///position, frame, etc.
    ///
    /// </para>
    /// </summary>
    public event FrameHandler? OnFrame
    {
        add
        {
            CheckDisposed();
            _onFrame += value;
            EnsureDispatcherRegistered();
        }

        remove
        {
            _onFrame -= value;
        }
    }

    private unsafe void EnsureDispatcherRegistered()
    {
        lock (dispatcherLock)
        {
            if (dispatcherRegistered)
            {
                return;
            }

            // Allocate GCHandle to keep this object alive
            gcHandle = GCHandle.Alloc(this, GCHandleType.Normal);

            // Register the dispatcher with the Wayland proxy
            var dataPtr = GCHandle.ToIntPtr(gcHandle);
            var result = WaylandNative.ProxyAddDispatcher(Handle, &DispatchEvent, dataPtr, IntPtr.Zero);
            if (result != 0)
            {
                gcHandle.Free();
                throw new InvalidOperationException("Failed to add dispatcher to zwp_tablet_pad_strip_v2");
            }

            dispatcherRegistered = true;
        }
    }

    [UnmanagedCallersOnly]
    private static unsafe int DispatchEvent(IntPtr userData, IntPtr target, uint opcode, WlMessage* message, WlArgument* args)
    {
        try
        {
            var handle = GCHandle.FromIntPtr(userData);
            var obj = (ZwpTabletPadStripV2)handle.Target!;
            var display = obj.Display;

            switch (opcode)
            {
                case 0: // source
                    if (obj._onSource != null)
                    {
                        var _source = args[0].u;
                        obj._onSource?.Invoke(_source);
                    }
                    break;
                case 1: // position
                    if (obj._onPosition != null)
                    {
                        var _position = args[0].u;
                        obj._onPosition?.Invoke(_position);
                    }
                    break;
                case 2: // stop
                    if (obj._onStop != null)
                    {
                        obj._onStop?.Invoke();
                    }
                    break;
                case 3: // frame
                    if (obj._onFrame != null)
                    {
                        var _time = args[0].u;
                        obj._onFrame?.Invoke(_time);
                    }
                    break;
                default:
                    return -1;
            }

            return 0;
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error in event dispatcher: {ex}");
            return -1;
        }
    }
    /// <summary>
    /// Set compositor feedback
    /// <para>
    /// <br/>
    /// Requests the compositor to use the provided feedback string<br/>
    /// associated with this strip. This request should be issued immediately<br/>
    /// after a zwp_tablet_pad_group_v2.mode_switch event from the corresponding<br/>
    /// group is received, or whenever the strip is mapped to a different<br/>
    /// action. See zwp_tablet_pad_group_v2.mode_switch for more details.<br/>
    /// <br/>
    /// Clients are encouraged to provide context-aware descriptions for<br/>
    /// the actions associated with the strip, and compositors may use this<br/>
    /// information to offer visual feedback about the button layout<br/>
    /// (eg. on-screen displays).<br/>
    /// <br/>
    /// The provided string 'description' is a UTF-8 encoded string to be<br/>
    /// associated with this ring, and is considered user-visible; general<br/>
    /// internationalization rules apply.<br/>
    /// <br/>
    /// The serial argument will be that of the last<br/>
    /// zwp_tablet_pad_group_v2.mode_switch event received for the group of this<br/>
    /// strip. Requests providing other serials than the most recent one will be<br/>
    /// ignored.<br/>
    /// <br/>
    /// </para>
    /// </summary>
    public unsafe void SetFeedback(string description, uint serial)
    {
        CheckDisposed();

        var args = stackalloc WlArgument[2];
        args[0].s = Utf8StringMarshaller.ConvertToUnmanaged(description);
        args[1].u = serial;

        const uint opcode = 0;

        var newProxy = WaylandNative.ProxyMarshalArrayFlags(
            Handle,
            opcode,
            (WlInterface*)IntPtr.Zero,
            0,
            0,
            (nint)args
        );
    }

    /// <summary>
    /// Destroy the strip object
    /// <para>
    /// <br/>
    /// This destroys the client's resource for this strip object.<br/>
    /// <br/>
    /// </para>
    /// </summary>
    public unsafe void Destroy()
    {
        CheckDisposed();

        var args = stackalloc WlArgument[0];

        const uint opcode = 1;

        var newProxy = WaylandNative.ProxyMarshalArrayFlags(
            Handle,
            opcode,
            (WlInterface*)IntPtr.Zero,
            0,
            0,
            (nint)args
        );
    }

    public static ZwpTabletPadStripV2 Create(nint handle, WlDisplay display)
    {
        return new ZwpTabletPadStripV2(handle, display);
    }
    protected override void Dispose(bool disposing)
    {
        if (gcHandle.IsAllocated)
        {
            gcHandle.Free();
        }
        base.Dispose(disposing);
    }
}
