// <auto-generated>
// This file was generated from tablet-v2.xml
// Stability: Stable
// Link: https://wayland.app/protocols/tablet-v2
// </auto-generated>

#nullable enable
#pragma warning disable CS1591
#pragma warning disable CS0108
#pragma warning disable CS8604

namespace WaylandDotnet.Stable;

using System;
using System.Runtime.CompilerServices;
using System.Runtime.InteropServices;
using System.Runtime.InteropServices.Marshalling;
using System.Text;
using WaylandDotnet;
using WaylandDotnet.Internal;
using WaylandDotnet.Stable;
using WaylandDotnet.Wlr;

/// <summary>
/// zwp_tablet_pad_v2
/// <para> a set of buttons, rings, strips and dials </para>
/// <para> Version: 2 </para>
/// <see>https://wayland.app/protocols/tablet-v2/#zwp_tablet_pad_v2</see>
/// </summary>
public sealed partial class ZwpTabletPadV2 : WaylandObject, IWaylandObjectFactory<ZwpTabletPadV2>
{
    public const string InterfaceName = "zwp_tablet_pad_v2";
    public static string _StaticInterfaceName => "zwp_tablet_pad_v2";
    public const int InterfaceVersion = 2;

    private GCHandle gcHandle;
    private bool dispatcherRegistered = false;
    private readonly object dispatcherLock = new object();

    public ZwpTabletPadV2(IntPtr handle, WlDisplay display) : base(handle, display, InterfaceName, InterfaceVersion)
    {
    }
    /// <summary> physical button state </summary>
    public enum ButtonState : uint
    {
        /// <summary>
        /// the button is not pressed
        /// </summary>
        Released = 0,
        /// <summary>
        /// the button is pressed
        /// </summary>
        Pressed = 1,
    }

    public delegate void GroupHandler(ZwpTabletPadGroupV2 padGroup);

    private GroupHandler? _onGroup;

    /// <summary>
    ///Group announced
    /// <para>
    ///
    ///Sent on zwp_tablet_pad_v2 initialization to announce available groups.
    ///One event is sent for each pad group available.
    ///
    ///This event is sent in the initial burst of events before the
    ///zwp_tablet_pad_v2.done event. At least one group will be announced.
    ///
    /// </para>
    /// </summary>
    public event GroupHandler? OnGroup
    {
        add
        {
            CheckDisposed();
            _onGroup += value;
            EnsureDispatcherRegistered();
        }

        remove
        {
            _onGroup -= value;
        }
    }

    public delegate void PathHandler(string path);

    private PathHandler? _onPath;

    /// <summary>
    ///Path to the device
    /// <para>
    ///
    ///A system-specific device path that indicates which device is behind
    ///this zwp_tablet_pad_v2. This information may be used to gather additional
    ///information about the device, e.g. through libwacom.
    ///
    ///The format of the path is unspecified, it may be a device node, a
    ///sysfs path, or some other identifier. It is up to the client to
    ///identify the string provided.
    ///
    ///This event is sent in the initial burst of events before the
    ///zwp_tablet_pad_v2.done event.
    ///
    /// </para>
    /// </summary>
    public event PathHandler? OnPath
    {
        add
        {
            CheckDisposed();
            _onPath += value;
            EnsureDispatcherRegistered();
        }

        remove
        {
            _onPath -= value;
        }
    }

    public delegate void ButtonsHandler(uint buttons);

    private ButtonsHandler? _onButtons;

    /// <summary>
    ///Buttons announced
    /// <para>
    ///
    ///Sent on zwp_tablet_pad_v2 initialization to announce the available
    ///buttons.
    ///
    ///This event is sent in the initial burst of events before the
    ///zwp_tablet_pad_v2.done event. This event is only sent when at least one
    ///button is available.
    ///
    /// </para>
    /// </summary>
    public event ButtonsHandler? OnButtons
    {
        add
        {
            CheckDisposed();
            _onButtons += value;
            EnsureDispatcherRegistered();
        }

        remove
        {
            _onButtons -= value;
        }
    }

    public delegate void DoneHandler();

    private DoneHandler? _onDone;

    /// <summary>
    ///Pad description event sequence complete
    /// <para>
    ///
    ///This event signals the end of the initial burst of descriptive
    ///events. A client may consider the static description of the pad to
    ///be complete and finalize initialization of the pad.
    ///
    /// </para>
    /// </summary>
    public event DoneHandler? OnDone
    {
        add
        {
            CheckDisposed();
            _onDone += value;
            EnsureDispatcherRegistered();
        }

        remove
        {
            _onDone -= value;
        }
    }

    public delegate void ButtonHandler(uint time, uint button, uint state);

    private ButtonHandler? _onButton;

    /// <summary>
    ///Physical button state
    /// <para>
    ///
    ///Sent whenever the physical state of a button changes.
    ///
    /// </para>
    /// </summary>
    public event ButtonHandler? OnButton
    {
        add
        {
            CheckDisposed();
            _onButton += value;
            EnsureDispatcherRegistered();
        }

        remove
        {
            _onButton -= value;
        }
    }

    public delegate void EnterHandler(uint serial, ZwpTabletV2 tablet, WlSurface surface);

    private EnterHandler? _onEnter;

    /// <summary>
    ///Enter event
    /// <para>
    ///
    ///Notification that this pad is focused on the specified surface.
    ///
    /// </para>
    /// </summary>
    public event EnterHandler? OnEnter
    {
        add
        {
            CheckDisposed();
            _onEnter += value;
            EnsureDispatcherRegistered();
        }

        remove
        {
            _onEnter -= value;
        }
    }

    public delegate void LeaveHandler(uint serial, WlSurface surface);

    private LeaveHandler? _onLeave;

    /// <summary>
    ///Leave event
    /// <para>
    ///
    ///Notification that this pad is no longer focused on the specified
    ///surface.
    ///
    /// </para>
    /// </summary>
    public event LeaveHandler? OnLeave
    {
        add
        {
            CheckDisposed();
            _onLeave += value;
            EnsureDispatcherRegistered();
        }

        remove
        {
            _onLeave -= value;
        }
    }

    public delegate void RemovedHandler();

    private RemovedHandler? _onRemoved;

    /// <summary>
    ///Pad removed event
    /// <para>
    ///
    ///Sent when the pad has been removed from the system. When a tablet
    ///is removed its pad(s) will be removed too.
    ///
    ///When this event is received, the client must destroy all rings, strips
    ///and groups that were offered by this pad, and issue zwp_tablet_pad_v2.destroy
    ///the pad itself.
    ///
    /// </para>
    /// </summary>
    public event RemovedHandler? OnRemoved
    {
        add
        {
            CheckDisposed();
            _onRemoved += value;
            EnsureDispatcherRegistered();
        }

        remove
        {
            _onRemoved -= value;
        }
    }

    private unsafe void EnsureDispatcherRegistered()
    {
        lock (dispatcherLock)
        {
            if (dispatcherRegistered)
            {
                return;
            }

            // Allocate GCHandle to keep this object alive
            gcHandle = GCHandle.Alloc(this, GCHandleType.Normal);

            // Register the dispatcher with the Wayland proxy
            var dataPtr = GCHandle.ToIntPtr(gcHandle);
            var result = WaylandNative.ProxyAddDispatcher(Handle, &DispatchEvent, dataPtr, IntPtr.Zero);
            if (result != 0)
            {
                gcHandle.Free();
                throw new InvalidOperationException("Failed to add dispatcher to zwp_tablet_pad_v2");
            }

            dispatcherRegistered = true;
        }
    }

    [UnmanagedCallersOnly]
    private static unsafe int DispatchEvent(IntPtr userData, IntPtr target, uint opcode, WlMessage* message, WlArgument* args)
    {
        try
        {
            var handle = GCHandle.FromIntPtr(userData);
            var obj = (ZwpTabletPadV2)handle.Target!;
            var display = obj.Display;

            switch (opcode)
            {
                case 0: // group
                    if (obj._onGroup != null)
                    {
                        ZwpTabletPadGroupV2? _padGroup = null;
                        if (args[0].o == (WlObject*)IntPtr.Zero) throw new InvalidOperationException("Received null object for non-nullable argument 'pad_group'");
                        _padGroup = new ZwpTabletPadGroupV2((IntPtr)args[0].o, obj.Display);
                        obj._onGroup?.Invoke(_padGroup);
                    }
                    break;
                case 1: // path
                    if (obj._onPath != null)
                    {
                        var _path = Utf8StringMarshaller.ConvertToManaged(args[0].s);
                        obj._onPath?.Invoke(_path);
                    }
                    break;
                case 2: // buttons
                    if (obj._onButtons != null)
                    {
                        var _buttons = args[0].u;
                        obj._onButtons?.Invoke(_buttons);
                    }
                    break;
                case 3: // done
                    if (obj._onDone != null)
                    {
                        obj._onDone?.Invoke();
                    }
                    break;
                case 4: // button
                    if (obj._onButton != null)
                    {
                        var _time = args[0].u;
                        var _button = args[1].u;
                        var _state = args[2].u;
                        obj._onButton?.Invoke(_time, _button, _state);
                    }
                    break;
                case 5: // enter
                    if (obj._onEnter != null)
                    {
                        var _serial = args[0].u;
                        ZwpTabletV2? _tablet = null;
                        if (args[1].o == (WlObject*)IntPtr.Zero) throw new InvalidOperationException("Received null object for non-nullable argument 'tablet'");
                        _tablet = new ZwpTabletV2((IntPtr)args[1].o, obj.Display);
                        WlSurface? _surface = null;
                        if (args[2].o == (WlObject*)IntPtr.Zero) throw new InvalidOperationException("Received null object for non-nullable argument 'surface'");
                        _surface = new WlSurface((IntPtr)args[2].o, obj.Display);
                        obj._onEnter?.Invoke(_serial, _tablet, _surface);
                    }
                    break;
                case 6: // leave
                    if (obj._onLeave != null)
                    {
                        var _serial = args[0].u;
                        WlSurface? _surface = null;
                        if (args[1].o == (WlObject*)IntPtr.Zero) throw new InvalidOperationException("Received null object for non-nullable argument 'surface'");
                        _surface = new WlSurface((IntPtr)args[1].o, obj.Display);
                        obj._onLeave?.Invoke(_serial, _surface);
                    }
                    break;
                case 7: // removed
                    if (obj._onRemoved != null)
                    {
                        obj._onRemoved?.Invoke();
                    }
                    break;
                default:
                    return -1;
            }

            return 0;
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error in event dispatcher: {ex}");
            return -1;
        }
    }
    /// <summary>
    /// Set compositor feedback
    /// <para>
    /// <br/>
    /// Requests the compositor to use the provided feedback string<br/>
    /// associated with this button. This request should be issued immediately<br/>
    /// after a zwp_tablet_pad_group_v2.mode_switch event from the corresponding<br/>
    /// group is received, or whenever a button is mapped to a different<br/>
    /// action. See zwp_tablet_pad_group_v2.mode_switch for more details.<br/>
    /// <br/>
    /// Clients are encouraged to provide context-aware descriptions for<br/>
    /// the actions associated with each button, and compositors may use<br/>
    /// this information to offer visual feedback on the button layout<br/>
    /// (e.g. on-screen displays).<br/>
    /// <br/>
    /// Button indices start at 0. Setting the feedback string on a button<br/>
    /// that is reserved by the compositor (i.e. not belonging to any<br/>
    /// zwp_tablet_pad_group_v2) does not generate an error but the compositor<br/>
    /// is free to ignore the request.<br/>
    /// <br/>
    /// The provided string 'description' is a UTF-8 encoded string to be<br/>
    /// associated with this ring, and is considered user-visible; general<br/>
    /// internationalization rules apply.<br/>
    /// <br/>
    /// The serial argument will be that of the last<br/>
    /// zwp_tablet_pad_group_v2.mode_switch event received for the group of this<br/>
    /// button. Requests providing other serials than the most recent one will<br/>
    /// be ignored.<br/>
    /// <br/>
    /// </para>
    /// </summary>
    public unsafe void SetFeedback(uint button, string description, uint serial)
    {
        CheckDisposed();

        var args = stackalloc WlArgument[3];
        args[0].u = button;
        args[1].s = Utf8StringMarshaller.ConvertToUnmanaged(description);
        args[2].u = serial;

        const uint opcode = 0;

        var newProxy = WaylandNative.ProxyMarshalArrayFlags(
            Handle,
            opcode,
            (WlInterface*)IntPtr.Zero,
            0,
            0,
            (nint)args
        );
    }

    /// <summary>
    /// Destroy the pad object
    /// <para>
    /// <br/>
    /// Destroy the zwp_tablet_pad_v2 object. Objects created from this object<br/>
    /// are unaffected and should be destroyed separately.<br/>
    /// <br/>
    /// </para>
    /// </summary>
    public unsafe void Destroy()
    {
        CheckDisposed();

        var args = stackalloc WlArgument[0];

        const uint opcode = 1;

        var newProxy = WaylandNative.ProxyMarshalArrayFlags(
            Handle,
            opcode,
            (WlInterface*)IntPtr.Zero,
            0,
            0,
            (nint)args
        );
    }

    public static ZwpTabletPadV2 Create(nint handle, WlDisplay display)
    {
        return new ZwpTabletPadV2(handle, display);
    }
    protected override void Dispose(bool disposing)
    {
        if (gcHandle.IsAllocated)
        {
            gcHandle.Free();
        }
        base.Dispose(disposing);
    }
}
